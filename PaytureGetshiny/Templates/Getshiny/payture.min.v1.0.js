/**
 * @fileOverview Payture.js is library to use in Payture paying templates
 * @version 1.0
 */
var Payture={defaults:{Type:"Default",TypeAPI:"InPay",Action:"PaySubmit",Event:"submit #payForm",RemoveEvent:"click #removeCard",TopErrorContainer:"#errorTop",PaymentKey:"",MasterPass:!1,MasterPassUseCVV:!1,Inbox:!1,DetectDevice:!0,CheckNumbers:!0,CheckLetters:!0,DetectCardType:!0,DisableButton:!0,GroupCardNumber:!0,ResizeCardNumberInput:!1,HideCardList:!0,MasterPassRedirected:!1,IsMobile:!1,IsTablet:!1,Data:{CardNumber:[$("input[name=CardNumber0]"),$("input[name=CardNumber1]"),$("input[name=CardNumber2]"),$("input[name=CardNumber3]")],EMonth:$("input[name=EMonth]"),EYear:$("input[name=EYear]"),CardHolder:$("input[name=CardHolder]"),SecureCode:$("input[name=SecureCode]")},TemplateErrors:{EmptyPan:"Введите от 16 до 19 знаков номера карты",EmptyDate:"Укажите дату, до которой действительна карта",EmptyMonth:"Укажите месяц, до которого действительна карта",EmptyYear:"Укажите год, до которого действительна карта",WrongDate:"Неверно указана дата",EmptyCardHolder:"Укажите имя владельца карты",EmptyCVV:"Укажите код CVV"},ServerErrors:{"default":"К сожалению, в настоящее время платеж с данной карты невозможен. Попробуйте оплатить другой картой",AMOUNT_EXCEED:"К сожалению, в настоящее время платеж с данной карты невозможен. Cвяжитесь со своим банком и попробуйте еще раз, либо воспользуйтесь другой картой",AMOUNT_EXCEED_BALANCE:"К сожалению, в настоящее время платеж с данной карты невозможен. Cвяжитесь со своим банком и попробуйте еще раз, либо воспользуйтесь другой картой",AUTHENTICATION_ERROR:"К сожалению, в настоящее время платеж с данной карты невозможен. Cвяжитесь со своим банком и попробуйте еще раз, либо воспользуйтесь другой картой",AUTHORIZATION_TIMEOUT:"К сожалению, в настоящее время платеж с данной карты невозможен. Cвяжитесь со своим банком и попробуйте еще раз, либо воспользуйтесь другой картой",COMMUNICATE_ERROR:"Ошибка возникла при передаче данных в МПС. Повторите попытку",DUPLICATE_ORDER_ID:"Номер заказа уже использовался ранее. Оформите новый заказ",FRAUD_ERROR:"К сожалению, в настоящее время платеж с данной карты невозможен. Попробуйте оплатить другой",FRAUD_ERROR_CRITICAL_CARD:"К сожалению, в настоящее время платеж с данной карты невозможен. Попробуйте оплатить другой",ILLEGAL_ORDER_STATE:"К сожалению, в настоящее время платеж с данной карты невозможен. Попробуйте оплатить другой",ISSUER_BLOCKED_CARD:"К сожалению, в настоящее время платеж с данной карты невозможен. Cвяжитесь со своим банком и попробуйте еще раз, либо воспользуйтесь другой картой",ISSUER_CARD_FAIL:"К сожалению, в настоящее время платеж с данной карты невозможен. Cвяжитесь со своим банком и попробуйте еще раз, либо воспользуйтесь другой картой",ISSUER_FAIL:"К сожалению, в настоящее время платеж с данной карты невозможен. Cвяжитесь со своим банком и попробуйте еще раз, либо воспользуйтесь другой картой",ISSUER_LIMIT_AMOUNT_FAIL:"Предпринята попытка выполнить транзакцию на сумму, превышающую лимит, заданный банком, выпустившим карту. Измените лимит и повторите попытку",ISSUER_LIMIT_COUNT_FAIL:"Превышен лимит на число транзакций, заданный банком, выпустившим карту. Измените лимит и повторите попытку",ISSUER_LIMIT_FAIL:"Предпринята попытка, превышающая ограничения, заданные банком, выпустившим карту, на сумму или количество операций в определенный промежуток времени. Измените ограничения и повторите попытку",ISSUER_TIMEOUT:"Нет связи с банком, выпустившим карту. Повторите попытку, либо воспользуйтесь другой картой",MERCHANT_RESTRICTION:"К сожалению, в настоящее время платеж с данной карты невозможен. Попробуйте оплатить другой",PROCESSING_ERROR:"К сожалению, в настоящее время платеж с данной карты невозможен. Cвяжитесь со своим банком и попробуйте еще раз, либо воспользуйтесь другой картой",LIMIT_EXCHAUST:"Время, отведенное для ввода данных, исчерпано. Оформите новый заказ",ORDER_TIME_OUT:"Время платежа (сессии) истекло. Оформите новый заказ",WRONG_CARD_PAN:"Неверный номер карты. Повторите ввод данных",WRONG_CARD_INFO:"Неверные параметры карты. Повторите ввод данных",WRONG_PARAMS:"Неверные параметры карты. Повторите ввод данных"},onBeforeSubmit:null,onSelectCard:null,onRemoveCard:null,onShowErrors:null,onHideErrors:null,onSuccess:function(e){$("form button").removeClass("loading").removeAttr("disabled"),$(".loader").hide(),$(".section").hide(),$("#result").show(),$("#result h3").text("Оплата прошла успешно!"),$("#result a").attr("href",e),setTimeout(function(){window.location.href=e},2e3)},onError:function(e,t,r){$("form button").removeClass("loading").removeAttr("disabled"),$(".loader").hide(),t?$(Payture.options.TopErrorContainer).text(Payture.options.ServerErrors[e]):($(".section").hide(),$("#result").show(),$("#result h3").text("Оплата не прошла!"),$("#result .message").text(Payture.options.ServerErrors[e]),$("#result a").attr("href",r),setTimeout(function(){window.location.href=r},2e3))}},enToRu:{"й":"q","ц":"w","у":"e","к":"r","е":"t","н":"y","г":"u","ш":"i","щ":"o","з":"p","ф":"a","ы":"s","в":"d","а":"f","п":"g","р":"h","о":"j","л":"k","д":"l","я":"z","ч":"x","с":"c","м":"v","и":"b","т":"n","ь":"m"},regexp:{isNumber:function(e){return/[0-9]/.test(String.fromCharCode(e))},isPan:function(e){return/3|4|5|6/.test(String.fromCharCode(e))}},options:{},InPay:function(e){e||(e={}),Payture.options=$.extend({},Payture.defaults,e),Payture.options.TypeAPI="InPay",e.Data||(Payture.options.Data={CardNumber:[$("input[name=CardNumber0]"),$("input[name=CardNumber1]"),$("input[name=CardNumber2]"),$("input[name=CardNumber3]")],EMonth:$("input[name=EMonth]"),EYear:$("input[name=EYear]"),CardHolder:$("input[name=CardHolder]"),SecureCode:$("input[name=SecureCode]")}),$(".section").hide(),Payture.options.Inbox?($("#paymentType").show(),Payture.inboxActions()):$("#paymentCard").show(),"JSON"!=Payture.options.Type||$.isEmptyObject(Payture.getJSONResponse())||Payture.options.onError(Payture.getJSONResponse().ErrCode,Payture.getJSONResponse().CanRetry,Payture.getJSONResponse().RedirectUrl),Payture.options.DetectDevice&&Payture.detectingDevice(),Payture.formActions(),Payture.options.MasterPass&&Payture.MasterPass(),$("html "+Payture.options.Event.split(" ")[1]).bind(Payture.options.Event.split(" ")[0],function(){return null!=Payture.options.onBeforeSubmit&&Payture.options.onBeforeSubmit(),$("form button").addClass("loading").attr("disabled",!0),Payture.Pay(Payture.options.MasterPass&&Payture.options.MasterPassRedirected?{Type:"MP",Key:$("input[name=Key]").val(),Card:Payture.getFormValues({SecureCode:$("input[name=SecureCode]"),oauth_Token:$("input[name=oauth_Token]")})}:{Type:Payture.options.Type,TypeAPI:"InPay",Key:$("input[name=Key]").val(),Card:Payture.getFormValues(Payture.options.Data)}),!1})},eWalletPay:function(e){e||(e={}),Payture.options=$.extend({},Payture.defaults,e),Payture.options.TypeAPI="eWallet",e.Data||(Payture.options.Data={CardId:$("select[name=CardId]"),CardNumber:[$("input[name=CardNumber0]"),$("input[name=CardNumber1]"),$("input[name=CardNumber2]"),$("input[name=CardNumber3]")],EMonth:$("input[name=EMonth]"),EYear:$("input[name=EYear]"),CardHolder:$("input[name=CardHolder]"),SecureCode:$("input[name=SecureCode]"),AddCard:$("input[name=AddCard]")}),$(".section").hide(),Payture.options.Inbox?($("#paymentType").show(),Payture.inboxActions()):$("#paymentCard").show(),"JSON"!=Payture.options.Type||$.isEmptyObject(Payture.getJSONResponse())||Payture.options.onError(Payture.getJSONResponse().ErrCode,Payture.getJSONResponse().CanRetry,Payture.getJSONResponse().RedirectUrl),Payture.options.DetectDevice&&Payture.detectingDevice(),Payture.changeCard($(Payture.options.Data.CardId).val(),$(Payture.options.Data.CardId).find("option:selected").text()),$(Payture.options.Data.CardId).change(function(){Payture.changeCard($(this).val(),$(this).find("option:selected").text())}),Payture.formActions(),Payture.options.MasterPass&&Payture.MasterPass(),$("html "+Payture.options.Event.split(" ")[1]).bind(Payture.options.Event.split(" ")[0],function(){return null!=Payture.options.onBeforeSubmit&&Payture.options.onBeforeSubmit(),$("form button").addClass("loading").attr("disabled",!0),Payture.Pay(Payture.options.MasterPass&&Payture.options.MasterPassRedirected?{Type:"MP",Key:$("input[name=Key]").val(),Card:Payture.getFormValues({CardId:$("select[name=CardId]"),SecureCode:$("input[name=SecureCode]"),oauth_Token:$("input[name=oauth_Token]"),AddCard:$("input[name=AddCard]")})}:{Type:Payture.options.Type,TypeAPI:"eWallet",Key:$("input[name=Key]").val(),Card:Payture.getFormValues(Payture.options.Data)}),!1}),$("html "+Payture.options.RemoveEvent.split(" ")[1]).bind(Payture.options.RemoveEvent.split(" ")[0],function(){return""!=Payture.options.PaymentKey&&"FreePay"!=$(Payture.options.Data.CardId).val()&&""!=$(Payture.options.Data.CardId).val()&&Payture.RemoveCard({CardId:$(Payture.options.Data.CardId).val(),PaymentKey:Payture.options.PaymentKey}),!1})},eWalletAdd:function(e){e||(e={}),Payture.options=$.extend({},Payture.defaults,e),Payture.options.TypeAPI="eWallet",e.Data||(Payture.options.Data={CardNumber:[$("input[name=CardNumber0]"),$("input[name=CardNumber1]"),$("input[name=CardNumber2]"),$("input[name=CardNumber3]")],EMonth:$("input[name=EMonth]"),EYear:$("input[name=EYear]"),CardHolder:$("input[name=CardHolder]"),SecureCode:$("input[name=SecureCode]")}),$(".section").hide(),Payture.options.Inbox?($("#paymentType").show(),Payture.inboxActions()):$("#paymentCard").show(),"JSON"!=Payture.options.Type||$.isEmptyObject(Payture.getJSONResponse())||Payture.options.onError(Payture.getJSONResponse().ErrCode,Payture.getJSONResponse().CanRetry,Payture.getJSONResponse().RedirectUrl),Payture.options.DetectDevice&&Payture.detectingDevice(),Payture.formActions(),$("html "+Payture.options.Event.split(" ")[1]).bind(Payture.options.Event.split(" ")[0],function(){return null!=Payture.options.onBeforeSubmit&&Payture.options.onBeforeSubmit(),$("form button").addClass("loading").attr("disabled",!0),Payture.Add({Type:Payture.options.Type,Key:$("input[name=Key]").val(),Card:Payture.getFormValues(Payture.options.Data)}),!1})},Pay:function(e){e.onSuccess||"JSON"!=e.Type||(e.onSuccess=Payture.options.onSuccess),e.onError||"JSON"!=e.Type||(e.onError=Payture.options.onError),"Default"==e.Type?Payture.submitForm("PaySubmit",Payture.inlineData(e.Key,e.Card)):"MP"==e.Type?Payture.submitForm("PaySubmitMP",Payture.inlineData(e.Key,e.Card)):"JSON"==e.Type&&Payture.submitFormJSON("PaySubmit",e.TypeAPI,Payture.inlineData(e.Key,e.Card),e.onSuccess,e.onError)},Add:function(e){e.onSuccess||"JSON"!=e.Type||(e.onSuccess=Payture.options.onSuccess),e.onError||"JSON"!=e.Type||(e.onError=Payture.options.onError),"Default"==e.Type?Payture.submitForm("AddSubmit",Payture.inlineData(e.Key,e.Card)):"JSON"==e.Type&&Payture.submitFormJSON("AddSubmit","eWallet",Payture.inlineData(e.Key,e.Card),e.onSuccess,e.onError)},Validate:function(e){return Payture.validationData[e.Name]?Payture.validationData[e.Name](e.Value):null},GetCardList:function(){var e={};return CardPANS&&0!=CardPANS.length&&$.each(CardPANS,function(t,r){e[r]={Id:t,NoCVV:CardNoCVVInfo&&CardNoCVVInfo[t]?CardNoCVVInfo[t]:void 0,Expired:CardExpiredInfo&&CardExpiredInfo[t]?CardExpiredInfo[t]:void 0,LastPay:CardLastSuccess&&CardLastSuccess[t]?new Date(CardLastSuccess[t]):void 0}}),e},RemoveCard:function(e){$.ajax({type:"GET",url:"/vwapi/Remove2?CardId="+e.CardId+"&VWID="+e.PaymentKey,timeout:3e4,success:function(t){var r=Payture.xmlToString(t);-1!=r.indexOf('Success="True"')&&(e.onRemove&&null!==e.onRemove?e.onRemove(e.CardId):Payture.updateList(e.CardId))},error:function(){alert("Произошла ошибка")}})},GetState:function(e,t,r,a){Payture.Timeout+=3e4,$.ajax({type:"POST",url:"/ncapi/GetState",data:{Key:e,NoCardPaymentType:t,CompileRedirectURL:!0},timeout:3e4,success:function(n){n.Success&&"Charged"==n.State?r&&r(n.ReturnUrl):n.Success&&"Authorized"==n.State&&Payture.Timeout<6e5?setTimeout(function(){Payture.GetState(e,t,r,a)},3e4):a&&a(n.ErrCode,!1,n.ReturnUrl)},error:function(){alert("Произошла ошибка")}})},updateList:function(e){null!==Payture.options.onRemoveCard?Payture.options.onRemoveCard(e):($(Payture.options.Data.CardId).find("option[value="+e+"]").remove(),Payture.options.HideCardList&&"eWallet"==Payture.options.TypeAPI&&Payture.hideCardList(),Payture.changeCard($(Payture.options.Data.CardId).val(),$(Payture.options.Data.CardId).find("option:selected").text()))},getPayLinks:function(){var e="Key="+$("input[name=Key]").val()+";isNoCard=true;NoCardPaymentType=",t=window.location;$("#paymentType a:not(.payCard)").each(function(){$(this).attr("href",t.protocol+"//"+t.host+"/apim/PaySubmit/?Data="+encodeURIComponent(e+$(this).attr("rel")))})},setNewKey:function(e){$("input[name=Key]").val(e)},detectingDevice:function(){Payture.options.IsTablet=device.tablet(),Payture.options.IsMobile=device.mobile()},getJSONResponse:function(){var responseJSON=$(".response_json").text();return-1==responseJSON.indexOf("{response_json}")?eval("("+responseJSON+")"):{}},inboxActions:function(){Payture.getPayLinks(),$("#paymentType a").click(function(){return $(this).is(".payCard")?($(".section").hide(),$("#paymentCard").show(),!1):($(".loader").fadeIn(150),Payture.NoCardPaymentType=$(this).attr("rel"),Payture.Timeout=0,setTimeout(function(){Payture.GetState($("input[name=Key]").val(),Payture.NoCardPaymentType,Payture.options.onSuccess,Payture.options.onError)},3e4),void 0)}),$("#reset").click(function(){$(".loader").hide(),Payture.NoCardPaymentType=void 0,Payture.Timeout=0}),$("#toBack").click(function(){return $(".section").hide(),$("#paymentType").show(),!1})},formActions:function(){Payture.options.DisableButton&&Payture.checkButton(),Payture.options.DetectCardType&&Payture.selectCardType(Payture.getPAN(Payture.options.Data.CardNumber)),!Payture.options.ResizeCardNumberInput||Payture.options.IsMobile||Payture.options.IsTablet||Payture.resizeInput(),Payture.options.HideCardList&&"eWallet"==Payture.options.TypeAPI&&Payture.hideCardList();var e="";$("*").focus(function(){e=Payture.defineFieldType(this)}),$("html input").bind({keypress:function(e){return Payture.hideErrors($(this)),$(this).is(".onlyNum")&&Payture.options.CheckNumbers?Payture.checkChar(e,"isNumber"):$(this).is(".onlyLat")&&Payture.options.CheckLetters?Payture.translateText(e,this):void 0},keyup:function(e){Payture.options.DetectCardType&&"CardNumber"==Payture.defineFieldType($(e.currentTarget))&&Payture.selectCardType(Payture.getPAN(Payture.options.Data.CardNumber)),Payture.options.DisableButton&&Payture.checkButton(),!Payture.options.ResizeCardNumberInput||Payture.options.IsMobile||Payture.options.IsTablet||"CardNumber"!=Payture.defineFieldType($(e.currentTarget))||Payture.resizeInput(),Payture.options.GroupCardNumber&&(Payture.options.IsTablet||Payture.options.IsMobile?$(this).is("[type=tel]")&&Payture.separatingNumber(e,this):Payture.changeCaretPosition(e,this))},blur:function(t){Payture.options.IsMobile&&$.each(Payture.options.Data,function(e,t){Payture.hideErrors(t)}),setTimeout(function(){Payture.defineFieldType($(t.currentTarget))!=e&&Payture.showErrors(Payture.Validate({Name:Payture.defineFieldType($(t.currentTarget)),Value:Payture.getFormValues(Payture.options.Data)[Payture.defineFieldType($(t.currentTarget))]}))},10)}})},hideCardList:function(){$(Payture.options.Data.CardId).length>0&&$(Payture.options.Data.CardId).find("option").length<2?$(".selectCard").hide():$(".selectCard").show()},changeCard:function(e,t){null!==Payture.options.onSelectCard?Payture.options.onSelectCard(e,t):("FreePay"==e?($.each(Payture.options.Data,function(e,t){Array.isArray(t)?$.each(t,function(e,t){$(t).val("").removeAttr("disabled")}):$(t).is("input")&&$(t).val("").removeAttr("disabled")}),$("#addCard").show().find("input").removeAttr("disabled"),$("html "+Payture.options.RemoveEvent.split(" ")[1]).hide()):(Payture.showCardStub(t,!0),$("#addCard").hide().find("input").attr("disabled",!0),$("html "+Payture.options.RemoveEvent.split(" ")[1]).show()),$.each(Payture.options.Data,function(e,t){Payture.hideErrors(t)}))},getFormValues:function(e){var t={};return $.each(e,function(e,r){if(Array.isArray(r)){if($(r[0]).is(":disabled"))return!0;t[e]=Payture.getPAN(r)}else if($(r).is(":input")){if($(r).is(":disabled"))return!0;t[e]=$(r).val(),"EMonth"==e&&(t[e]=Payture.addValue($(r).val())),"CardNumber"==e&&(Payture.options.IsMobile||Payture.options.IsTablet)&&(t[e]=$(r).val().replace(/\s/g,"")),"AddCard"==e&&(t[e]=$(r).is(":checked")?"True":"")}else("function"==typeof r||"string"==typeof r)&&(t[e]=r)}),t},defineFieldType:function(e){var t="";return $.each(Payture.options.Data,function(r,a){Array.isArray(a)?$.each(a,function(){$(this).is(e)&&(t=r)}):$(this).is("input")&&$(a).is(e)&&(t=r)}),t},getPAN:function(e){return $.map(e,function(e){return $(e).val()}).join("")},inlineData:function(e,t){return"Key="+e+";"+$.map(t,function(e,t){return t+"="+e}).join(";")},submitForm:function(e,t){var r=$("<form></form>").attr({method:"POST",action:e});r.appendTo($("body")),$("<input />").attr({type:"hidden",name:"Data"}).appendTo(r).val(t),r.submit()},submitFormJSON:function(e,t,r,a,n){$.ajax({type:"POST",url:("InPay"==t?"/apim/":"/vwapi/")+e,data:{Data:r,Json:!0},timeout:3e4,success:function(e){console.log(e,$("form button")),$("form button").removeClass("loading").removeAttr("disabled"),e.ACSUrl&&Payture.submitForm3DS(e.ACSUrl,e.TermUrl,e.ThreeDSKey,e.PaReq),e.Success?a&&a(e.RedirectUrl):(Payture.setNewKey(e.Key),n&&n(e.ErrCode,e.CanRetry,e.RedirectUrl,e.Key))},error:function(){alert("Произошла ошибка")}})},submitForm3DS:function(e,t,r,a){var n=$("<form name='form' action='"+e+"' method='post'><input type='hidden' name='TermUrl' value='"+t+"'><input type='hidden' name='MD' value='"+r+"'><input type='hidden' name='PaReq' value='"+a+"'></form>").appendTo($("body"));n.submit()},validationData:{CardNumber:function(e){return{Success:e.length>15,ErrorMessage:Payture.options.TemplateErrors.EmptyPan,Element:"CardNumber"}},CardTo:function(e){return{Success:e.length>15,ErrorMessage:Payture.options.TemplateErrors.EmptyPan,Element:"CardTo"}},EMonth:function(e){if("xx"==e.toLowerCase())return{Success:!0};var t=Payture.getFormValues(Payture.options.Data).EYear;return""==e||"00"==e?""==t?Payture.validationData.ExpiredDate(e,t):{Success:""!=e&&"00"!=e,ErrorMessage:Payture.options.TemplateErrors.EmptyMonth,Element:"EYear"}:""==t?{Success:""!=e&&"00"!=e,ErrorMessage:Payture.options.TemplateErrors.EmptyMonth,Element:"EYear"}:Payture.validationData.ExpiredDate(e,t)},EYear:function(e){if("xx"==e.toLowerCase())return{Success:!0};var t=Payture.getFormValues(Payture.options.Data).EMonth;return""==e||"00"==e?""==t?Payture.validationData.ExpiredDate(t,e):{Success:""!=e&&"00"!=e,ErrorMessage:Payture.options.TemplateErrors.EmptyYear,Element:"EYear"}:""==t?Payture.validationData.EMonth(t):Payture.validationData.ExpiredDate(t,e)},ExpiredDate:function(e,t){var r=new Date,a=100*r.getFullYear()+r.getMonth()+1,n=100*(2e3+1*t)+1*e;return{Success:n>=a&&13>1*e,ErrorMessage:Payture.options.TemplateErrors.WrongDate,Element:"EYear"}},CardHolder:function(e){return{Success:e.length>2,ErrorMessage:Payture.options.TemplateErrors.EmptyCardHolder,Element:"CardHolder"}},SecureCode:function(e){return{Success:3==e.length,ErrorMessage:Payture.options.TemplateErrors.EmptyCVV,Element:"SecureCode"}}},addValue:function(e){return 1==e.length?"0"+e:e},selectCardType:function(e){$(".CardType").removeClass("visa master"),""!=e&&("4"==e.charAt(0)?$(".CardType").addClass("visa"):("5"==e.charAt(0)||"6"==e.charAt(0))&&$(".CardType").addClass("master"))},showErrors:function(e){if(null===e)return!1;if(null!==Payture.options.onShowErrors)Payture.options.onShowErrors(e);else if(!e.Success){var t;t=Array.isArray(Payture.options.Data[e.Element])?Payture.options.Data[e.Element][0].parents(".form_row"):Payture.options.Data[e.Element].parents(".form_row"),Payture.options.IsMobile?$(".error").text(e.ErrorMessage).fadeIn(200):$(t).find(".error").text(e.ErrorMessage).fadeIn(200),$(t).find("input").addClass("wrong")}},hideErrors:function(e){null!==Payture.options.onHideErrors?Payture.options.onHideErrors(e):Array.isArray(e)?$.each(e,function(){$(this).parents(".form_row").find(".error").text("").hide(),$(this).parents(".form_row").find("input").removeClass("wrong")}):$(e).is("input")&&($(e).parents(".form_row").find(".error").text("").hide(),$(e).parents(".form_row").find("input").removeClass("wrong"))},checkButton:function(){var e=!0;$.each(Payture.getFormValues(Payture.options.Data),function(t,r){return"CardId"==t||"AddCard"==t?!0:void(Payture.Validate({Name:t,Value:r}).Success||(e=!1))}),$("form button").attr("disabled",!e)},separatingNumber:function(e,t){e=e?e:window.event;var r=e.which?e.which:e.keyCode,a=Payture.getCaretPosition(t),n=t.value.replace(/\s/g,""),o=t.value.length;a%5==0&&8!=r&&(a+=o>a?1:2),a>3&&a%5==0&&8==r&&16>a&&(a+=-1),t.value=n.length<16?n.replace(/(\d{4})/gi,"$1 ").trim():n.replace(/(\d{4})(\d{4})(\d{4})(\d{4,})/gi,"$1 $2 $3 $4").trim(),Payture.setCaretPosition(t,a)},setCaretPosition:function(e,t){if(null!=e)if(e.createTextRange){var r=e.createTextRange();r.move("character",t),r.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},getCaretPosition:function(e){var t=0;if(document.selection){e.focus();var r=document.selection.createRange();r.moveStart("character",-ctrl.value.length),t=r.text.length}else(e.selectionStart||"0"==e.selectionStart)&&(t=e.selectionStart);return t},changeCaretPosition:function(e,t){e=e?e:window.event;var r=e.which?e.which:e.keyCode,a=($(t).attr("name"),$(t).attr("maxLength")),n=$(t).attr("next"),o=$(t).attr("prev"),u=$(t).val();9!=r&&37!=r&&39!=r&&16!=r&&(u.length==a&&n&&$("[name="+n+"]").focus(),8==r&&0==u.length&&o&&$("[name="+o+"]").focus())},resizeInput:function(){var e=$("input[name='CardNumber3']");return 0==e.length?!1:void e.width(e.val().length>4?"66px":"57px")},checkChar:function(e,t){return $.browser.mozilla?e.keyCode?!0:Payture.regexp[t](e.charCode):Payture.regexp[t](e.keyCode)},getRuByEn:function(e){return Payture.enToRu[e]?Payture.enToRu[e]:e},changeRuToEn:function(e){var t="";return $.each(e.split(""),function(){t+=Payture.getRuByEn(this)}),t},translateText:function(e,t){var r=e.charCode?e.charCode:e.keyCode,a=String.fromCharCode(r),n=Payture.changeRuToEn(a.toLowerCase()),o=t.value,u=/[A-Z ]/i,i=0;if(document.selection){var s=document.selection.createRange();s.moveStart("textedit",-1),i=s.text.length}else i=t.selectionStart;if(8==r||9==r||32==r||46==r||r>36&&41>r)return!0;var d="";return u.test(String.fromCharCode(r))?(d=String.fromCharCode(r),t.value=o.substring(0,i)+d+o.substring(i,o.length),t.selectionStart=i+1,t.selectionEnd=i+1):u.test(n)&&(d=n,t.value=o.substring(0,i)+d+o.substring(i,o.length),t.selectionStart=i+1,t.selectionEnd=i+1),!1},xmlToString:function(e){return window.ActiveXObject?e.xml:(new XMLSerializer).serializeToString(e)},showCardStub:function(e,t){if(Array.isArray(Payture.options.Data.CardNumber))$.each(Payture.options.Data.CardNumber,function(t,r){$(r).val(e.substring(4*t,4*t+4)).attr("disabled",!0)});else if($(Payture.options.Data.CardNumber).is("input")){var r=e.replace(/((\d|\D){4})/gi,"$1 ").trim();$(Payture.options.Data.CardNumber).val(r).attr("disabled",!0)}$(Payture.options.Data.EMonth).is("input")&&$(Payture.options.Data.EMonth).val("XX").attr("disabled",!0),$(Payture.options.Data.EYear).is("input")&&$(Payture.options.Data.EYear).val("XX").attr("disabled",!0),$(Payture.options.Data.CardHolder).is("input")&&$(Payture.options.Data.CardHolder).val("CardHolder Name").attr("disabled",!0),$(Payture.options.Data.SecureCode).is("input")&&(1==t?$(Payture.options.Data.SecureCode).val(""):$(Payture.options.Data.SecureCode).val("XXX").attr("disabled",!0))},formatInt:function(e){if(null==e||void 0==e||""==e)return"0.00";var t=e.toString();t=t.replace(/(\d+)(\d\d)/g,"$1.$2");var r=/(\d+)(\.\d{1,2})/g.exec(t)?/(\d+)(\.\d{1,2})/g.exec(t)[2]:"";return t=/(\d+)(\.\d{1,2})/g.exec(t)?/(\d+)(\.\d{1,2})/g.exec(t)[1]:t,t=t.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1&nbsp;"),t+r},MasterPass:function(){Payture.GetCardInfo(),-1!=window.location.href.indexOf("checkout_resource_url")&&-1!=window.location.href.indexOf("oauth_verifier")?Payture.setMasterPass():($("form .payBlock").addClass("MPPayBlock"),$("#masterPass").on("click",function(){return Payture.RedirectMasterPass(),!1}))},GetCardInfo:function(){var e=Payture.getURLParam("oauth_token"),t=Payture.getURLParam("oauth_verifier"),r=Payture.getURLParam("checkout_resource_url");""!=e&&""!=t&&""!=r&&$.ajax({type:"POST",url:"/mpapi/GetCardInfo",data:{json:"true",oauth_Token:e,oauth_Verifier:t,checkout_Resource_Url:r},timeout:3e4,success:function(e){void 0!=e.PANMask&&Payture.showCardStub(e.PANMask,Payture.options.MasterPassUseCVV)},error:function(){alert("Произошла ошибка")}})},setMasterPass:function(){Payture.options.MasterPassRedirected=!0;var e=Payture.getURLParam("oauth_token");$("input[name=oauth_Token]").val(e),Payture.showCardStub("XXXXXXXXXXXXXXXX",Payture.options.MasterPassUseCVV),Payture.checkButton()},RedirectMasterPass:function(){var e=$("input[name='Amount']").val();$.ajax({type:"POST",url:"/mpapi/RedirectMasterPass",data:{callbackUrl:window.location.href.replace("&","[a]"),json:"true",Key:$("input[name='Key']").val(),shopingCart:e+":VashaPokupka|1|"+e+";"},timeout:3e4,success:function(e){location.href=e.Url},error:function(){alert("Произошла ошибка")}})},getURLParam:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),r=t.exec(location.search);return null===r?"":decodeURIComponent(r[1].replace(/\+/g," "))},showCheck:function(){var e=$("#amount_kopecs").text();if(""!=e){var t=$("#amount_currency").text(),r="";("RUR"==t||"RUB"==t)&&(r="руб.");var a=Payture.formatInt(e)+" "+r;$("#sumFinal").html(a),$("#sendCheckEmail").click(function(){Payture.sendCheckEmail()})}else $(".container.returnCheck").hide(),$(".container.return").show()}};